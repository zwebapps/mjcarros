version: '3.9'

services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init-simple.js:/docker-entrypoint-initdb.d/mongo-init-simple.js:ro

  nextjs:
    container_name: nextjs
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:3000"
    depends_on:
      - mongodb
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      MONGO_USERNAME: ${MONGO_USERNAME:-mjcarros}
      MONGO_PASSWORD: ${MONGO_PASSWORD:-786Password}
      MONGO_HOST: ${MONGO_HOST:-mongodb}
      MONGO_PORT: ${MONGO_PORT:-27017}
      MONGO_DATABASE: ${MONGO_DATABASE:-mjcarros}
      MONGO_AUTH_SOURCE: ${MONGO_AUTH_SOURCE:-mjcarros}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@mjcarros.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-Admin123!}
      ADMIN_NAME: ${ADMIN_NAME:-Administrator}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      PAYPAL_CLIENT_ID: ${PAYPAL_CLIENT_ID}
      PAYPAL_CLIENT_SECRET: ${PAYPAL_CLIENT_SECRET}
      PAYPAL_WEBHOOK_ID: ${PAYPAL_WEBHOOK_ID}
      PAYPAL_ENV: ${PAYPAL_ENV}
      NEXT_PUBLIC_PAYPAL_CLIENT_ID: ${NEXT_PUBLIC_PAYPAL_CLIENT_ID}
      JWT_SECRET: ${JWT_SECRET}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      AWS_BUCKET_NAME: ${AWS_BUCKET_NAME}
      NEXT_PUBLIC_S3_BASE_URL: ${NEXT_PUBLIC_S3_BASE_URL}
      NEXT_PUBLIC_APP_URL: http://nextjs:3000
      STRIPE_REDIRECT_URL: http://localhost:8080
      NEXT_PUBLIC_SITE_NAME: ${NEXT_PUBLIC_SITE_NAME:-MJ Carros}
      NEXT_PUBLIC_SITE_ADDRESS1: ${NEXT_PUBLIC_SITE_ADDRESS1:-178 Expensive Avenue}
      NEXT_PUBLIC_SITE_CITY: ${NEXT_PUBLIC_SITE_CITY:-Philadelphia, 20100 PH}
      NEXT_PUBLIC_SITE_PHONE: ${NEXT_PUBLIC_SITE_PHONE:-+1 (555) 000-0000}
      NEXT_PUBLIC_SITE_EMAIL: ${NEXT_PUBLIC_SITE_EMAIL:-info@mjcarros.com}
      NEXT_PUBLIC_SITE_WEB: ${NEXT_PUBLIC_SITE_WEB:-www.mjcarros.com}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      EMAIL_FROM: ${EMAIL_FROM}
    # depends_on defined above; removing duplicate
    volumes:
      - ./public/uploads:/app/public/uploads:rw
    command: >
      sh -c "
        echo 'â³ Waiting for MongoDB...' &&
        sleep 5 &&
        echo 'ğŸ‘¤ Creating admin user...' &&
        npm run setup-admin &&
        echo 'ğŸš€ Starting Next.js...' &&
        npm run start
      "

volumes:
  mongodb_data:
